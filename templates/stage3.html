<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hardware Challenge - Stage 3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    <link href="/static/css/styles.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5 main-content">
        <h1>Hardware Challenge - Stage 3</h1>
        <p class="lead">Write a function to process the circuit logic and generate the correct output.</p>
        
        <div class="row mt-4">
            <div class="col-md-8">
                <h3>Your Code:</h3>
                <textarea id="codeEditor"></textarea>
                <button class="btn btn-primary mt-3" onclick="testCode()">Test Solution</button>
            </div>
            <div class="col-md-4">
                <h3>Instructions:</h3>
                <ul>
                    <li>Write a function that processes the input data</li>
                    <li>Your function should return a string of binary digits</li>
                    <li>The input data is available in the <code>inputData</code> array</li>
                    <li>Each row contains 4 numbers (0 or 1)</li>
                </ul>
            </div>
        </div>

        <div class="output-area">
            <h3>Output:</h3>
            <pre id="output"></pre>
            <button id="decodeBtn" class="btn btn-success mt-3" onclick="decodeBinary()" style="display: none;">Decode</button>
            <pre id="asciiOutput"></pre>
            <div id="flagSubmission" style="display: none;" class="mt-4">
                <h4>Submit Flag:</h4>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="flagInput" placeholder="Enter the decoded flag">
                    <button class="btn btn-primary" onclick="submitFlag()">Submit Flag</button>
                </div>
                <div id="flagFeedback" class="feedback"></div>
            </div>
        </div>
    </div>

    <div class="progress-container">
        <div class="container">
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="stage-indicator">
                <span>Stage 1</span>
                <span>Stage 2</span>
                <span class="active">Stage 3</span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="/static/js/input-data.js"></script>
    <script src="/static/js/validator.js"></script>
    <script>
        // Initialize CodeMirror
        var editor = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
            mode: "javascript",
            theme: "monokai",
            lineNumbers: true,
            autoCloseBrackets: true
        });

        // Set default code
        editor.setValue(`function processLogic(inputData) {
    // Your code here
    // Return a string of binary digits
    return "";
}`);

        function testCode() {
            const outputElement = document.getElementById("output");
            const decodeBtn = document.getElementById("decodeBtn");
            const asciiOutput = document.getElementById("asciiOutput");
            
            try {
                // Get the user's code
                const userCode = editor.getValue();
                
                // Create a function from the user's code
                const userFunction = new Function('inputData', userCode + '\nreturn processLogic(inputData);');
                
                // Run the user's code
                const result = userFunction(inputData);
                
                // Validate the result
                if (validateOutput(result)) {
                    outputElement.innerHTML = result;
                    outputElement.style.color = "green";
                    // Show decode button
                    decodeBtn.style.display = "inline-block";
                    // Store the binary result for decoding
                    decodeBtn.dataset.binary = result;
                } else {
                    outputElement.innerHTML = "❌ Incorrect output. Try again!";
                    outputElement.style.color = "red";
                    // Hide decode button
                    decodeBtn.style.display = "none";
                    asciiOutput.style.display = "none";
                }
            } catch (error) {
                outputElement.innerHTML = "❌ Error: " + error.message;
                outputElement.style.color = "red";
                // Hide decode button
                decodeBtn.style.display = "none";
                asciiOutput.style.display = "none";
            }
        }

        function decodeBinary() {
            const binary = document.getElementById("decodeBtn").dataset.binary;
            const asciiOutput = document.getElementById("asciiOutput");
            const flagSubmission = document.getElementById("flagSubmission");
            
            // Convert binary to ASCII
            let ascii = '';
            for (let i = 0; i < binary.length; i += 8) {
                const byte = binary.substr(i, 8);
                ascii += String.fromCharCode(parseInt(byte, 2));
            }
            
            // Display the ASCII result
            asciiOutput.textContent = `Retrieved Message: ${ascii}`;
            asciiOutput.style.display = "block";
            
            // Show flag submission field
            flagSubmission.style.display = "block";
        }

        function submitFlag() {
            const userFlag = document.getElementById("flagInput").value;
            const flagFeedback = document.getElementById("flagFeedback");
            const correctFlag = "HTB{4_G00d_Cm05_3x4mpl3}";
            
            if (userFlag === correctFlag) {
                flagFeedback.textContent = "✅ Correct! Redirecting to completion page...";
                flagFeedback.className = "feedback correct";
                flagFeedback.style.display = "block";
                setTimeout(() => {
                    window.location.href = "completion.html";
                }, 1500);
            } else {
                flagFeedback.textContent = "❌ Incorrect flag. Try again!";
                flagFeedback.className = "feedback incorrect";
                flagFeedback.style.display = "block";
            }
        }
    </script>
</body>
</html> 